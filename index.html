<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Master Marbling - Absolute Fit</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* Using dvh (Dynamic Viewport Height) to account for mobile bars */
        html, body { 
            margin: 0; padding: 0; 
            width: 100vw; height: 100dvh; 
            overflow: hidden; background: #000; 
            font-family: system-ui, -apple-system, sans-serif;
        }

        #app-container {
            display: flex;
            width: 100vw;
            height: 100dvh;
            background: #120c08;
        }

        /* Portrait: Tray top (max 70% height), UI bottom filler */
        @media (orientation: portrait) {
            #app-container { flex-direction: column; }
            #stage { 
                width: 100vw; 
                height: 70dvh; /* Limit tray to 70% of height max */
                flex-shrink: 0; 
            }
            #ui { flex: 1; width: 100%; border-top: 2px solid #3d2b1f; }
        }

        /* Landscape: Tray left (max 70% width), UI right filler */
        @media (orientation: landscape) {
            #app-container { flex-direction: row; }
            #stage { 
                height: 100dvh; 
                width: 70vw; /* Limit tray to 70% of width max */
                flex-shrink: 0; 
            }
            #ui { flex: 1; height: 100%; border-left: 2px solid #3d2b1f; }
        }

        #stage { 
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
        }

        #ui { 
            background: #1e140d; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            overflow-y: auto; 
            color: #e2d1b3;
        }

        canvas { background: #fdfaf0; touch-action: none; display: block; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .label { font-size: 10px; font-weight: 800; color: #b39e7d; text-transform: uppercase; margin-bottom: 2px; }
        
        .palette-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .swatch { height: 30px; border-radius: 4px; border: 2px solid #3d2b1f; cursor: pointer; }
        .swatch.active { border-color: #ffd700; transform: scale(1.05); }

        .control-row { display: flex; flex-direction: column; }
        
        button { 
            cursor: pointer; padding: 8px; border: 1px solid #7a5c3e; 
            border-radius: 4px; background: #a67c52; color: #fff; font-size: 11px;
            font-weight: 600;
        }
        button.active { background: #ffd700; color: #3d2b1f; }
        
        input[type="range"] { accent-color: #ffd700; margin: 4px 0; height: 20px; }
        input[type="color"] { width: 100%; height: 25px; border: none; background: transparent; cursor: pointer; }

        .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: auto; padding-top: 5px;}
    </style>
</head>
<body>

<div id="app-container">
    <div id="stage">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="ui">
        <div class="control-row">
            <span class="label">Colors</span>
            <div class="palette-grid" id="palette">
                <div class="swatch active" style="background:#8b0000" data-color="#8b0000"></div>
                <div class="swatch" style="background:#003366" data-color="#003366"></div>
                <div class="swatch" style="background:#ccac00" data-color="#ccac00"></div>
                <div class="swatch" style="background:#224422" data-color="#224422"></div>
            </div>
            <input type="color" id="colorPicker" value="#8b0000">
        </div>
        
        <div class="control-row">
            <span class="label">Paint Viscosity</span>
            <input type="range" id="viscositySlider" min="0.2" max="3.0" step="0.1" value="1.2">
            <span class="label">Tool Size</span>
            <input type="range" id="sizeSlider" min="0.1" max="4.0" step="0.1" value="1.0">
        </div>

        <div class="control-row">
            <span class="label">Tools</span>
            <div style="display:flex; gap:3px">
                <button id="dropBtn" class="active" style="flex:1">Drop</button>
                <button id="stylusBtn" style="flex:1">Needle</button>
                <button id="rakeBtn" style="flex:1">Rake</button>
            </div>
        </div>

        <div class="footer">
            <button id="undoBtn" style="background:#3d2b1f" disabled>Undo</button>
            <button id="resetBtn" style="background:transparent; border:1px solid #3d2b1f">Clear</button>
            <button id="saveBtn" style="background:#4a6741; grid-column: span 2;">Export Art</button>
        </div>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

const fragmentShader = `
    uniform sampler2D tPrev;
    uniform vec2 uMouse;
    uniform vec2 uPrevMouse;
    uniform int uMode; 
    uniform vec3 uColor;
    uniform float uViscosity;
    uniform float uBrushSize;
    varying vec2 vUv;
    void main() {
        vec2 uv = vUv;
        vec3 paper = vec3(0.99, 0.98, 0.94);
        if (uMode == 0) {
            float d = distance(uv, uMouse);
            float r = 0.05 * uBrushSize;
            if (d > 0.0001) {
                float m = sqrt(1.0 + (r*r)/(d*d));
                uv = uMouse + (uv - uMouse)/m;
            }
            vec4 b = texture2D(tPrev, uv);
            if(b.a < 0.1) b = vec4(paper, 1.0);
            gl_FragColor = (d < r) ? vec4(uColor, 1.0) : b;
        } else if (uMode > 0) {
            vec2 dir = uMouse - uPrevMouse;
            vec2 advUv = uv;
            if (uMode == 1) {
                float d = distance(uv, uMouse);
                float inf = exp(-d / (0.008 * uBrushSize));
                advUv -= dir * inf * uViscosity;
            } else {
                vec2 perp = vec2(-(uMouse.y-uPrevMouse.y), uMouse.x-uPrevMouse.x);
                for(float i = -4.0; i <= 4.0; i++) {
                    vec2 nPos = uMouse + (normalize(perp + 0.00001) * i * 0.1);
                    float inf = exp(-distance(uv, nPos) / (0.015 * uBrushSize));
                    advUv -= dir * inf * (uViscosity * 0.7);
                }
            }
            vec4 s = texture2D(tPrev, advUv);
            gl_FragColor = (s.a < 0.1) ? vec4(paper, 1.0) : s;
        } else {
            vec4 c = texture2D(tPrev, uv);
            gl_FragColor = (c.a < 0.1) ? vec4(paper, 1.0) : c;
        }
    }
`;

let canvasSize;
const canvas = document.getElementById('mainCanvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });

let read, write;
const history = [];

const scene = new THREE.Scene();
const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
const material = new THREE.ShaderMaterial({
    uniforms: {
        tPrev: { value: null }, uMouse: { value: new THREE.Vector2(-1,-1) },
        uPrevMouse: { value: new THREE.Vector2(-1,-1) }, uMode: { value: -1 },
        uColor: { value: new THREE.Color() }, uViscosity: { value: 1.2 },
        uBrushSize: { value: 1.0 }
    },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = vec4(position, 1.0); }`,
    fragmentShader
});
scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material));

function init() {
    const stage = document.getElementById('stage');
    // Force tray to be a square that fits within its assigned stage area
    canvasSize = Math.min(stage.clientWidth, stage.clientHeight);
    
    renderer.setSize(canvasSize, canvasSize);
    read = new THREE.WebGLRenderTarget(canvasSize, canvasSize);
    write = new THREE.WebGLRenderTarget(canvasSize, canvasSize);
    material.uniforms.tPrev.value = read.texture;
    reset();
}

function reset() {
    renderer.setClearColor(0xfdfaf0, 1);
    [read, write].forEach(rt => { renderer.setRenderTarget(rt); renderer.clear(); });
    renderer.setRenderTarget(null);
    history.forEach(rt => rt.dispose()); history.length = 0;
    document.getElementById('undoBtn').disabled = true;
}

function captureState() {
    const snap = new THREE.WebGLRenderTarget(canvasSize, canvasSize);
    renderer.setRenderTarget(snap); renderer.render(scene, camera);
    history.push(snap);
    if (history.length > 15) history.shift().dispose();
    document.getElementById('undoBtn').disabled = false;
}

function undo() {
    if (history.length === 0) return;
    const last = history.pop();
    material.uniforms.uMode.value = -1;
    material.uniforms.tPrev.value = last.texture;
    [read, write].forEach(rt => { renderer.setRenderTarget(rt); renderer.render(scene, camera); });
    renderer.setRenderTarget(null);
    material.uniforms.tPrev.value = read.texture;
    last.dispose();
    document.getElementById('undoBtn').disabled = history.length === 0;
}

function animate() {
    requestAnimationFrame(animate);
    material.uniforms.uViscosity.value = parseFloat(document.getElementById('viscositySlider').value);
    material.uniforms.uBrushSize.value = parseFloat(document.getElementById('sizeSlider').value);
    renderer.setRenderTarget(write);
    renderer.render(scene, camera);
    material.uniforms.tPrev.value = write.texture;
    [read, write] = [write, read];
    renderer.setRenderTarget(null);
    renderer.render(scene, camera);
}

let activeColor = "#8b0000";
let activeMode = 0;
let drawing = false;

const swatches = document.querySelectorAll('.swatch');
swatches.forEach(sw => {
    sw.onclick = () => {
        swatches.forEach(s => s.classList.remove('active'));
        sw.classList.add('active');
        activeColor = sw.dataset.color;
        document.getElementById('colorPicker').value = activeColor;
    };
});

document.getElementById('colorPicker').oninput = (e) => {
    activeColor = e.target.value;
    const activeSw = document.querySelector('.swatch.active');
    activeSw.style.background = activeColor;
    activeSw.dataset.color = activeColor;
};

const getMouse = (e) => {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return new THREE.Vector2((cx - rect.left)/canvasSize, 1 - (cy - rect.top)/canvasSize);
};

const onDown = (e) => {
    if (e.target.closest('#ui')) return;
    captureState();
    const pos = getMouse(e);
    material.uniforms.uMouse.value.copy(pos);
    material.uniforms.uPrevMouse.value.copy(pos);
    material.uniforms.uMode.value = activeMode;
    material.uniforms.uColor.value.set(activeColor);
    drawing = true;
};

const onMove = (e) => {
    if (!drawing) return;
    material.uniforms.uPrevMouse.value.copy(material.uniforms.uMouse.value);
    material.uniforms.uMouse.value.copy(getMouse(e));
};

window.addEventListener('mousedown', onDown);
window.addEventListener('mousemove', onMove);
window.addEventListener('mouseup', () => { drawing = false; material.uniforms.uMode.value = -1; });
window.addEventListener('touchstart', onDown, {passive: false});
window.addEventListener('touchmove', onMove, {passive: false});
window.addEventListener('touchend', () => { drawing = false; material.uniforms.uMode.value = -1; });

window.addEventListener('resize', () => location.reload());
document.getElementById('undoBtn').onclick = undo;
document.getElementById('resetBtn').onclick = reset;
document.getElementById('dropBtn').onclick = () => { activeMode = 0; setActive('dropBtn'); };
document.getElementById('stylusBtn').onclick = () => { activeMode = 1; setActive('stylusBtn'); };
document.getElementById('rakeBtn').onclick = () => { activeMode = 2; setActive('rakeBtn'); };
document.getElementById('saveBtn').onclick = () => {
    const link = document.createElement('a');
    link.download = 'marbling.png';
    link.href = canvas.toDataURL();
    link.click();
};

function setActive(id) {
    ['dropBtn', 'stylusBtn', 'rakeBtn'].forEach(b => document.getElementById(b).classList.toggle('active', b === id));
}

init();
animate();
</script>
</body>
</html>
