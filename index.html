<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wooden Marbling Studio</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: none; }
        
        body { 
            width: 100vw; height: 100dvh; 
            background: #000;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* The Wooden Boxes */
        .wooden-box {
            border: 8px solid #3d2b1f; /* "Frame" */
            background-color: #5c4033; /* "Wood grain" base */
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
        }

        /* Top Box: The Tray */
        #tray-box {
            flex: 1; /* Takes up all available top space */
            margin: 5px;
            border-radius: 8px;
        }

        /* Bottom Box: The UI */
        #ui-box {
            flex: 0 0 auto; /* Height is determined by its buttons */
            margin: 5px;
            padding: 15px;
            border-radius: 8px;
            flex-direction: column;
            gap: 10px;
        }

        canvas { 
            background: #fdfaf0; 
            display: block; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
        }

        .row { display: flex; width: 100%; gap: 10px; }
        
        .swatch { width: 35px; height: 35px; border-radius: 4px; border: 2px solid #222; }
        .swatch.active { border-color: #ffd700; transform: scale(1.1); }

        button { 
            flex: 1; padding: 12px 0; border: none; border-radius: 4px; 
            background: #8b5a2b; color: #fff; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        button.active { background: #ffd700; color: #000; }
        
        input[type="range"] { flex: 1; accent-color: #ffd700; }
    </style>
</head>
<body>

<div id="tray-box" class="wooden-box">
    <canvas id="mCanvas"></canvas>
</div>

<div id="ui-box" class="wooden-box">
    <div class="row">
        <div class="swatch active" style="background:#8b0000" data-color="#8b0000"></div>
        <div class="swatch" style="background:#003366" data-color="#003366"></div>
        <div class="swatch" style="background:#ccac00" data-color="#ccac00"></div>
        <div class="swatch" style="background:#224422" data-color="#224422"></div>
        <input type="range" id="size" min="0.1" max="3.0" step="0.1" value="1.0">
    </div>

    <div class="row">
        <button id="btnDrop" class="active">Drop</button>
        <button id="btnNeedle">Needle</button>
        <button id="btnRake">Rake</button>
        <button id="btnSave" style="background:#3d5c33">Save</button>
    </div>
</div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
<script type="module">
import * as THREE from 'three';

const fragmentShader = `
    uniform sampler2D tPrev; uniform vec2 uMouse; uniform vec2 uPrevMouse;
    uniform int uMode; uniform vec3 uColor; uniform float uSize;
    varying vec2 vUv;
    void main() {
        vec2 uv = vUv; vec3 paper = vec3(0.99, 0.98, 0.94);
        if (uMode == 0) {
            float d = distance(uv, uMouse); float r = 0.05 * uSize;
            if (d > 0.0001) { float m = sqrt(1.0 + (r*r)/(d*d)); uv = uMouse + (uv - uMouse)/m; }
            vec4 b = texture2D(tPrev, uv); if(b.a < 0.1) b = vec4(paper, 1.0);
            gl_FragColor = (d < r) ? vec4(uColor, 1.0) : b;
        } else if (uMode > 0) {
            vec2 dir = uMouse - uPrevMouse; vec2 advUv = uv;
            float d = distance(uv, uMouse); 
            float inf = exp(-d / (uMode == 1 ? 0.01 : 0.03) * uSize);
            advUv -= dir * inf;
            vec4 s = texture2D(tPrev, advUv); gl_FragColor = (s.a < 0.1) ? vec4(paper, 1.0) : s;
        } else {
            vec4 c = texture2D(tPrev, uv); gl_FragColor = (c.a < 0.1) ? vec4(paper, 1.0) : c;
        }
    }
`;

const canvas = document.getElementById('mCanvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
let tSize, read, write, activeColor = "#8b0000", activeMode = 0, drawing = false;

const scene = new THREE.Scene(), camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
const material = new THREE.ShaderMaterial({
    uniforms: { tPrev: { value: null }, uMouse: { value: new THREE.Vector2(-1,-1) }, uPrevMouse: { value: new THREE.Vector2(-1,-1) }, uMode: { value: -1 }, uColor: { value: new THREE.Color() }, uSize: { value: 1.0 } },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = vec4(position, 1.0); }`,
    fragmentShader
});
scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material));

function init() {
    const area = document.getElementById('tray-box');
    tSize = Math.min(area.clientWidth, area.clientHeight) - 30;
    renderer.setSize(tSize, tSize);
    read = new THREE.WebGLRenderTarget(tSize, tSize);
    write = new THREE.WebGLRenderTarget(tSize, tSize);
    material.uniforms.tPrev.value = read.texture;
    renderer.setClearColor(0xfdfaf0, 1);
    [read, write].forEach(rt => { renderer.setRenderTarget(rt); renderer.clear(); });
    renderer.setRenderTarget(null);
}

function animate() {
    requestAnimationFrame(animate);
    material.uniforms.uSize.value = parseFloat(document.getElementById('size').value);
    if (material.uniforms.uMode.value !== -1) {
        renderer.setRenderTarget(write); renderer.render(scene, camera);
        material.uniforms.tPrev.value = write.texture;
        [read, write] = [write, read];
        renderer.setRenderTarget(null);
    }
    renderer.render(scene, camera);
}

const getMouse = (e) => {
    const rect = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return new THREE.Vector2((cx - rect.left)/tSize, 1 - (cy - rect.top)/tSize);
};

window.addEventListener('touchstart', (e) => {
    if (e.target.closest('#ui-box')) return;
    const pos = getMouse(e);
    material.uniforms.uMouse.value.copy(pos); material.uniforms.uPrevMouse.value.copy(pos);
    material.uniforms.uMode.value = activeMode; material.uniforms.uColor.value.set(activeColor);
    drawing = true;
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    if (!drawing) return;
    material.uniforms.uPrevMouse.value.copy(material.uniforms.uMouse.value);
    material.uniforms.uMouse.value.copy(getMouse(e));
}, {passive: false});

window.addEventListener('touchend', () => { drawing = false; material.uniforms.uMode.value = -1; });

document.querySelectorAll('.swatch').forEach(sw => {
    sw.onclick = () => {
        document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
        sw.classList.add('active'); activeColor = sw.dataset.color;
    };
});

document.getElementById('btnDrop').onclick = () => { activeMode = 0; upd(0); };
document.getElementById('btnNeedle').onclick = () => { activeMode = 1; upd(1); };
document.getElementById('btnRake').onclick = () => { activeMode = 2; upd(2); };
document.getElementById('btnSave').onclick = () => {
    const link = document.createElement('a'); link.download = 'art.png'; link.href = canvas.toDataURL(); link.click();
};

function upd(m) {
    ['btnDrop', 'btnNeedle', 'btnRake'].forEach((id, i) => document.getElementById(id).classList.toggle('active', i === m));
}

window.addEventListener('resize', init);
init();
animate();
</script>
</body>
</html>
